name: CI-CD-ETL-Demo

on:
  push:
    branches:
      - main

# REQUIRED for Workload Identity Federation
permissions:
  id-token: write
  contents: read

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      # 1Ô∏è Checkout code
      - name: Checkout repository
        uses: actions/checkout@v4

      # 2 Authenticate to GCP using Workload Identity Federation
      - name: Authenticate to GCP
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: projects/812107349915/locations/global/workloadIdentityPools/github-pool/providers/github-provider
          service_account: github-ci@etl-poc-demo1-487211.iam.gserviceaccount.com

      # 3 Install gcloud SDK
      - name: Set up gcloud
        uses: google-github-actions/setup-gcloud@v2

      # 4 üîç DEBUG ‚Äî SHOW EXACTLY WHICH ACCOUNT GCLOUD IS USING
      - name: Debug gcloud authentication
        run: |
          echo "===== gcloud auth list ====="
          gcloud auth list
          echo "===== gcloud config list ====="
          gcloud config list

      # 5 üîí FORCE GCLOUD TO USE THE CORRECT SERVICE ACCOUNT
      - name: Force gcloud account
        run: |
          gcloud config set account github-ci@etl-poc-demo1-487211.iam.gserviceaccount.com

      # 6 üîç VERIFY ACCOUNT AFTER FORCING
      - name: Verify active gcloud account
        run: |
          echo "Active account:"
          gcloud config get-value account
          echo "Trying to mint access token..."
          gcloud auth print-access-token >/dev/null
          echo "Access token OK"

      # 7Ô∏è Build & Deploy to Cloud Run (EXPLICIT SERVICE ACCOUNT)
      - name: Build & Deploy to Cloud Run
        run: |
          gcloud run deploy etl-demo \
            --source . \
            --region ${{ secrets.GCP_REGION }}  \
            --platform managed \
            --service-account github-ci@etl-poc-demo1-487211.iam.gserviceaccount.com \
            --allow-unauthenticated

      # 8 Done
      - name: Deployment completed
        run: echo "CI/CD pipeline completed successfully"
